#cloud-config
package_upgrade: true
packages:
  - nginx
groups:
  - docker
system_info:
  default_user:
    groups: [ docker ]

# Setup swap memory
disk_setup:
    ephemeral0:
        table_type: mbr
        layout: [66, [33, 82]]
        overwrite: True
fs_setup:
    - device: ephemeral0.1
      filesystem: ext4
    - device: ephemeral0.2
      filesystem: swap
mounts:
    - ["ephemeral0.1", "/mnt"]
    - ["ephemeral0.2", "none", "swap", "sw", "0", "0"]

# Enable Docker's swap limit support (System restart required)
bootcmd:
    - [ sh, -c, 'sudo echo GRUB_CMDLINE_LINUX=\"cgroup_enable=memory swapaccount=1\" >> /etc/default/grub' ]
    - [ sh, -c, 'sudo update-grub' ]

write_files:
  - path: /etc/systemd/system/container.service
    owner: root:root
    permissions: '0755'
    content: |
        [Unit]
        Description=Run container
        Requires=docker.service
        After=docker.service

        [Service]
        Restart=always
        ExecStartPre=-/usr/bin/docker rm container
        ExecStart=/usr/bin/docker run --rm --name container -p 4000:${container_port} ${environment_variables} ${container_image}:${container_tag}
        ExecStop=/usr/bin/docker stop -t 2 container

  - owner: www-data:www-data
    path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 80;
        location / {
          proxy_pass http://localhost:4000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection keep-alive;
          proxy_set_header Host $host;
          proxy_cache_bypass $http_upgrade;
        }
      }

runcmd:
  - [ sh, -c, 'curl -sSL https://get.docker.com/ | sh' ]
  - systemctl start container
  - systemctl enable container
  - service nginx restart

final_message: "The system is finally up, after $UPTIME seconds"
